install_www_files  ./  ${INSTALL_ROOT}${DRUPAL_INSTALL_PATH}/${SPELL}                                          &&

if  [  "${DRUPAL_INSTALLED}"  ==  "n"  ];  then
  if  [  "${DRUPAL_CREATEDB}"  ==  "y"  ];  then
    case  "${DRUPAL_DATABASE_ENGINE}"  in
      mysql)
        message  "${MESSAGE_COLOR}Creating MySQL database...${DEFAULT_COLOR}"
        mysqladmin  create  ${DRUPAL_DATABASE_NAME}                                                            &&
        echo  "GRANT ALL PRIVILEGES ON ${DRUPAL_DATABASE_NAME}.*                                               \
              TO ${DRUPAL_DATABASE_USER}@${DRUPAL_DATABASE_HOST} IDENTIFIED BY '${DRUPAL_DATABASE_PASSWORD}';  \
              flush privileges;                                                                                \
              \q "  |  mysql  ${DRUPAL_DATABASE_NAME}                                                          &&
        #
        # Return true as this will fail if the database already exists
        #
        mysql  ${DRUPAL_DATABASE_NAME}  <  database/database.mysql  ||  true
        ;;

      postgresql)
        message  "${MESSAGE_COLOR}Creating PostgreSQL database...${DEFAULT_COLOR}"
        source  /etc/sysconfig/postgresql                                                                      &&
        su  ${USER}  -c  "createdb  ${DRUPAL_DATABASE_NAME}"                                                   &&
        echo  "GRANT ALL PRIVILEGES ON ${DRUPAL_DATABASE_NAME}.*                                               \
              TO ${DRUPAL_DATABASE_USER}@${DRUPAL_DATABASE_HOST} IDENTIFIED BY '${DRUPAL_DATABASE_PASSWORD}';  \
              flush privileges;                                                                                \
              \q "  |  su  ${USER}  -c  "psql  ${DRUPAL_DATABASE_NAME}"                                        &&
        #
        # Return true as this will fail if the database already exists
        #
        su  ${USER}  -c  "psql  ${DRUPAL_DATABASE_NAME}  -f  database/database.pgsql"  ||  true
        ;;
    esac
  fi                                                                                                           &&

  if  [  "${DRUPAL_CONFIGURE}"  ==  "y"  ];  then
    # Update the sites/default/settings.php configuration file
    # The database connection string
    sedit  "s|username:password@localhost/database|${DRUPAL_DATABASE_USER}:${DRUPAL_DATABASE_PASSWORD}@${DRUPAL_DATABASE_HOST}/${DRUPAL_DATABASE_NAME}|"  ${INSTALL_ROOT}/${DRUPAL_INSTALL_PATH}/${SPELL}/sites/default/settings.php  &&

    # The base URL string
    sedit  "s|http://localhost|http://localhost/${SPELL}|"  ${INSTALL_ROOT}/${DRUPAL_INSTALL_PATH}/${SPELL}/sites/default/settings.php  &&

    mkdir  ${INSTALL_ROOT}/${DRUPAL_INSTALL_PATH}/${SPELL}/files
  fi                                                                                                           &&

  chown  -R  www-data:www-data  ${INSTALL_ROOT}/${DRUPAL_INSTALL_PATH}/${SPELL}
fi
