message "${MESSAGE_COLOR}If this is the first cast of postfix,"
message "you may want to run newaliases to make it work right now.${DEFAULT_COLOR}"

if [ "$ALIAS" == "n" ]; then
  message "${MESSAGE_COLOR}Don't forget to run newaliases to apply your changes on the alias file.${DEFAULT_COLOR}"
else
  newaliases
fi

# look for a backup file
backup_file=`ls -t -1 -r /etc/postfix-backup* | tail --lines=1`

if [ "$backup_file" != "" ]; then
  if [ "$RESTORE" == "n" ]; then
    message "${MESSAGE_COLOR}Restore skipped. (you can still use $backup_file lather yourself)${DEFAULT_COLOR}"
  else
    message "${MESSAGE_COLOR}Restoring config files... ${DEFAULT_COLOR}"
    tar -C / -xyvPf $backup_file
  fi
else
  message "${MESSAGE_COLOR}No backup for config files found. ${DEFAULT_COLOR}"
fi


#
# postfix 2.x.x new directives needed (at least) :
#
if [ -e /etc/postfix/master.cf ]; then

     relayCheck=`cat /etc/postfix/master.cf | grep relay`
  proxymapCheck=`cat /etc/postfix/master.cf | grep proxymap`

  if [ "$relayCheck" == "" ]; then
    if query "${MESSAGE_COLOR}The relay directive is missing in /etc/postfix/master.cf... Add it now ? ${DEFAULT_COLOR}" y
    then
      echo "# The next line was automatically added:" >> /etc/postfix/master.cf
      echo "relay     unix  -       -       n       -       -       smtp" >> /etc/postfix/master.cf
    fi
  fi
  
  if [ "$proxymapCheck" == "" ]; then
    if query "${MESSAGE_COLOR}The proxymap directive is missing in /etc/postfix/master.cf... Add it now ? ${DEFAULT_COLOR}" y
    then
      echo "# The next line was automatically added:" >> /etc/postfix/master.cf
      echo "proxymap  unix  -       -       n       -       -       proxymap" >> /etc/postfix/master.cf
    fi
  fi
fi

/etc/init.d/postfix.sh  start
