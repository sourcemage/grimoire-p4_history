if  [  "$EXISCAN"  ==   "y"  ]
then
  message  "${MESSAGE_COLOR}Patching for exiscan${DEFAULT_COLOR}"  &&
  bzcat  ${SOURCE_CACHE}/${SOURCE2}  |  patch  -p1
fi  &&

IVER=$( installed_version  exim |  cut  -c1  )
if    [  "$IVER"  ==  "3"  ]
then  if    [  -e  /etc/exim.conf  ]
      then  mv     /etc/exim.conf  /etc/exim.conf.$IVER
      fi
fi

create_account exim
create_account mail

mkdir  -p             /var/spool/mail
chmod  1777           /var/spool/mail
chown      exim:exim  /var/spool/mail
[  -e                 /var/spool/mail/db      ]  &&
chown  -R  exim:exim  /var/spool/mail/db
[  -e                 /var/spool/mail/input   ]  &&
chown  -R  exim:exim  /var/spool/mail/input
[  -e                 /var/spool/mail/log     ]  &&
chown  -R  exim:exim  /var/spool/mail/log
[  -e                 /var/spool/mail/msglog  ]  &&
chown  -R  exim:exim  /var/spool/mail/msglog

chown  -R  exim:exim  /var/spool/mail/db     /var/spool/mail/db/*
chown  -R  exim:exim  /var/spool/mail/input  /var/spool/mail/input/*
chown  -R  exim:exim  /var/spool/mail/log    /var/spool/mail/log/*
chown  -R  exim:exim  /var/spool/mail/msglog /var/spool/mail/msglog/*
chgrp      exim       /var/spool/mail/*

mkdir  -p  Local

if  [  "$XFREE86"  ==  "y"  ]
then
  cp  src/EDITME           Local/Makefile
  cp  exim_monitor/EDITME  Local/eximon.conf
else
   grep  -v  "EXIM_MONITOR="  src/EDITME  >  Local/Makefile
fi  &&

if  [  "$TCPWRAPPERS"  ==  "y"  ]
then
  echo  "USE_TCP_WRAPPERS=yes"  >> Local/Makefile
  echo  "EXTRALIBS=-lwrap"      >> Local/Makefile
fi  &&

if  [  "$LINUXPAM"  ==  "y"  ]
then
  echo  "SUPPORT_PAM=yes"  >>  Local/Makefile
  if  spell_ok  tcp_wrappers
  then  echo  "EXTRALIBS=-lpam -ldl -lwrap"  >>  Local/Makefile  
  else  echo  "EXTRALIBS=-lpam -ldl"         >>  Local/Makefile  
  fi
fi  &&

if  [  "$MYSQL"  ==  "y"  ]
then
  echo  "LOOKUP_MYSQL=yes"                     >>  Local/Makefile
  echo  "LOOKUP_INCLUDE=-I /usr/include/mysql" >>  Local/Makefile
  echo  "LOOKUP_LIBS=-lmysqlclient"            >>  Local/Makefile
fi  &&

if  [  "$OPENLDAP"  ==  "y"  ]
then
  echo  "LOOKUP_LDAP=yes"           >>  Local/Makefile
  echo  "LOOKUP_LIBS=-lldap -llber" >>  Local/Makefile
  echo  "LDAP_LIB_TYPE=OPENLDAP2"   >>  Local/Makefile
fi  &&

echo  "BIN_DIRECTORY=/usr/sbin"          >>  Local/Makefile
echo  "CONFIGURE_FILE=/etc/exim.conf"    >>  Local/Makefile
echo  "SPOOL_DIRECTORY=/var/spool/mail"  >>  Local/Makefile
echo  "LOG_FILE_PATH=/var/log/exim_%s:"  >>  Local/Makefile
echo  "CFLAGS=$CFLAGS"                   >>  Local/Makefile
echo  "EXIM_UID=`id -u exim`"            >>  Local/Makefile
echo  "EXIM_GID=`id -g exim`"            >>  Local/Makefile
echo  "EXIM_USER=exim"                   >>  Local/Makefile
echo  "EXIM_GROUP=exim"                  >>  Local/Makefile

sedit  's:tail \-1:tail \-n 1:'  scripts/Configure-config.h  &&
make
