if spell_installed postfix; then
  message "You have the oportunity here to setup Mail-SpamAssassin"
  message "as  a global default spam filter (directly  inserted to"
  message "postfix's master.cf file)."
  message "These modifications should be reverted when you dispell"
  message "the  Mail-SpamAssassin  spell  (under most conditions)."

  if query "Setup Mail-SpamAssassin as default global spam filter ?" n
  then
    OUTPUT_FILE="/etc/postfix/master.cf"
    grep "postfixfilter" /etc/passwd
    if [ $? -ne 0 ]; then
      useradd -s /bin/false postfixfilter
    fi
  else
    message "Skipping... (output to /etc/postfix/master.cf-Mail-SpamAssassin-sample instead)."
    OUTPUT_FILE="/etc/postfix/master.cf-Mail-SpamAssassin-sample"
  fi

  CUR_DATE=`date +%y.%m.%d.%S`
  cp /etc/postfix/master.cf /etc/postfix/master.cf.backup-Mail-SpamAssassin-$CUR_DATE

  FILTER_SIGNATURE="# Begin Mail-SpamAssassin filtering rules...DO NOT REMOVE THIS LINE..."
  grep "$FILTER_SIGNATURE" $OUTPUT_FILE 1>/dev/null 2>&1

  if [ $? -eq 0 ] && [ "$OUTPUT_FILE" == "/etc/postfix/master.cf" ]; then
    message "Mail-SpamAssassin filter signature found in master.cf."
    message "master.cf update skiped.".
  else
    message "Updating $OUTPUT_FILE"
    echo "# ==========================================================================" >> $OUTPUT_FILE
    echo $FILTER_SIGNATURE >> $OUTPUT_FILE
    echo "# ==========================================================================" >> $OUTPUT_FILE

    if [ "$OUTPUT_FILE" == "/etc/postfix/master.cf-Mail-SpamAssassin-sample" ]; then
      cp /etc/postfix/master.cf $OUTPUT_FILE 1>/dev/null 2>&1
    fi

    cp $SCRIPT_DIRECTORY/postfixfilter /usr/sbin &&
    perl -i -pe 's/^(smtp\s.*\ssmtpd\s*)$/$1 -o content_filter=postfixfilter:\n/' $OUTPUT_FILE

    PFF_EXE=/usr/sbin/postfixfilter
    echo >> $OUTPUT_FILE 'postfixfilter unix - n n - - pipe'
    echo >> $OUTPUT_FILE "  flags=Rq user=postfixfilter argv=$PFF_EXE "     ' -f ${sender} -- ${recipient}'

    if [ -e /etc/postfix/master.cf-rollback.patch ] && [ "$OUTPUT_FILE" == "/etc/postfix/master.cf" ]; then
      message "A previous rollback file (used to restore your master.cf without"
      message "Mail-SpamAssassin) was found."
      message "Updating twice master.cf, or rollbacking (at dispel time) using"
      message "an  incorrect  rollback  file  may cause  unpredictable result,"
      message "and corrupt your master.cf file..."
       
      if query "Do you want to erase previous rollback file ?" n
      then
        message "A copy of original master.cf file is left in /etc/postfix directory..."
        message "(just in case ;)"
      else
        diff /etc/postfix/master.cf /etc/postfix/master.cf.backup-Mail-SpamAssassin-$CUR_DATE > /etc/postfix/master.cf-rollback.patch
        rm -f /etc/postfix/master.cf.backup-Mail-SpamAssassin-$CUR_DATE
      fi
    else
      diff /etc/postfix/master.cf /etc/postfix/master.cf.backup-Mail-SpamAssassin-$CUR_DATE > /etc/postfix/master.cf-rollback.patch
      rm -f /etc/postfix/master.cf.backup-Mail-SpamAssassin-$CUR_DATE
    fi
  fi
fi
