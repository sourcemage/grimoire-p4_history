#!/usr/bin/perl -w

if( exists $ENV{EDITOR} != 1 ) {
	print "EDITOR environment variable not defined ( use: export EDITOR=vi )\n";
	exit 1;
}

chdir("/etc/init.d") || die $!;

my ($ent,$desc,$val,$flags,$dir,$rc0,$rc1,$rc2,$rc3,$rc4,$rc5,$rc6,$rcS);
my %list;

#$ARGC=@ARGV;
open(TMP,">/tmp/rlve.$$.tmp") || die $!;
print TMP << 'EOT';
#
# SourceMage: Run Level Editor
#
# Runlevels
# 0: halt the computer
# 1: single-user mode
# 2: multi-user mode without networking
# 3: multi-user mode with networking
# 4: reserved for customization, otherwise does the same as 3
# 5: multiuser mode, with networking and GUI login (xdm, gdm, kdm)
# 6: reboot the computer
# 
# S: not really meant to be used directly, but more for the scripts 
#    that are executed when entering runlevel 1. For more information 
#    on this,  see  the  man-pages for shutdown(8) and inittab(5).
#
# Usage: 
#   Just place to appropriate character as follows in the placeholder for
#   each runlevel that you want to have the service started or stoped:
#   
#   o - start service
#   x - stop service
#
# Example: Here apache is shown. 
#  (clarification has been requested from submitter as to how to set
#   the start and stop numerical values...)
#
# Name          99  0123456S  Description
#
# apache        10  xxxooox-  -*-*-*-*-
#

EOT

open(LS,"ls|") || die $!;
while (<LS>) {
	chomp;    next if /~/ or /#/ or /\.(old|bak|sav|orig|sik|[0-9]+)$/;
	next if -d $_ or $_ eq 'rc' or $_ eq 'boot' or $_ eq 'down' or $_ eq 'functions';
	($ent,$val,$desc)=($_,99,1);
	$ent1 = $ent;
	$ent1 =~ s/\.sh$//g;

	open(SR,"ls /etc/*.d/[SK]*$ent1 2>/dev/null |") || die $!;
	while (<SR>) {
		next unless m,/etc/rc([\dX]|S).d/[SK](\d+)$ent1,;
		$val=sprintf("%02d",$2);
	}
	close SR;
	$list{"$desc-$val-$ent"}=$ent1;
}
close LS;

foreach (sort keys %list) {
	($ent,$desc,$val,$rc0,$rc1,$rc2,$rc3,$rc4,$rc5,$rc6,$rcS)=
		($list{$_},"-*-*-*-*-",99,'-','-','-','-','-','-','-','-');
		#open(F,"<$ent") || die $!;
		#while (<F>) {
			#next unless /^#\s+Desc:\s+(.*)/;
			#$desc=$1;
			#}
			#close F;
	open(SR,"ls /etc/*.d/[SK]*$ent 2>/dev/null |") || die $!;
	while (<SR>) {
		next unless m,/etc/(rc[\dX]|rcS).d/([SK])(\d+)$ent,;
		#next unless m,/etc/(rc[\dX]).d/([SK])(\d+)$ent,;
#print "#$1-$2-$3-$4-$5#\n";
		$val=$3;
		if( $2 eq "S" ) {
			$rc0='o' if $1 eq 'rc0';
			$rc1='o' if $1 eq 'rc1';
			$rc2='o' if $1 eq 'rc2';
			$rc3='o' if $1 eq 'rc3';
			$rc4='o' if $1 eq 'rc4';
			$rc5='o' if $1 eq 'rc5';
			$rc6='o' if $1 eq 'rc6';
			$rcS='o' if $1 eq 'rcS';
		}	
		if( $2 eq "K" ) {
			$rc0='x' if $1 eq 'rc0';
			$rc1='x' if $1 eq 'rc1';
			$rc2='x' if $1 eq 'rc2';
			$rc3='x' if $1 eq 'rc3';
			$rc4='x' if $1 eq 'rc4';
			$rc5='x' if $1 eq 'rc5';
			$rc6='x' if $1 eq 'rc6';
			$rcS='x' if $1 eq 'rcS';
		}
	}
	close SR;
	printf TMP "%-15s %02d  $rc0$rc1$rc2$rc3$rc4$rc5$rc6$rcS  $desc\n",$ent,$val;
}
close TMP;

system("$ENV{'EDITOR'} /tmp/rlve.$$.tmp");

print "\n\nSave modifications (yes/no) ? [no]";
$save=<STDIN>;
exit 0 if substr($save,0,3) ne "yes";

$backup="/etc/rc_bak";
system("rm -rf $backup/");
mkdir("$backup",0755) || die $!;
rename("/etc/rc0.d","$backup/rc0.d") || die $!;    mkdir("/etc/rc0.d",0755) || die $!;
rename("/etc/rc1.d","$backup/rc1.d") || die $!;    mkdir("/etc/rc1.d",0755) || die $!;
rename("/etc/rc2.d","$backup/rc2.d") || die $!;    mkdir("/etc/rc2.d",0755) || die $!;
rename("/etc/rc3.d","$backup/rc3.d") || die $!;    mkdir("/etc/rc3.d",0755) || die $!;
rename("/etc/rc4.d","$backup/rc4.d") || die $!;    mkdir("/etc/rc4.d",0755) || die $!;
rename("/etc/rc5.d","$backup/rc5.d") || die $!;    mkdir("/etc/rc5.d",0755) || die $!;
rename("/etc/rc6.d","$backup/rc6.d") || die $!;    mkdir("/etc/rc6.d",0755) || die $!;
rename("/etc/rcS.d","$backup/rcS.d") || die $!;    mkdir("/etc/rcS.d",0755) || die $!;

print "Backup saved in $backup directory.\n";

open(TMP,"</tmp/rlve.$$.tmp") || die $!;
while (<TMP>) {
	chomp;
	next if /^\s*$/ or /^\s*#/;
	next unless /^(\S+)\s+(\d+)\s+(\S+)/;
	($ent,$val,$flags)=($1,$2,$3);
	#$flags=~s/b/-/g if $flags=~/[0-6]/;
#print "f:$flags \n";	
	$src="/etc/init.d";
	$dest="/etc";

	for ($i = 0; $i < 8; ++$i) {
		$dir="$dest/rc$i";
		$dir="$dest/rcS" if $i == 7;
		if( substr($flags,$i,1) eq 'o' ) {
			symlink("$src/$ent.sh","$dir.d/S$val$ent");
		} 
		if( substr($flags,$i,1) eq 'x' ) {
			$_=sprintf("$dir.d/K%02d$ent",100-$val);
			symlink("$src/$ent.sh","$_");
		}
	}
}
close TMP;

system("rm -rf /tmp/rlve.$$.tmp*");
