# net-tools CONFIGURE script
#
# Created 2006-03-22 by Matthew Clark <MatthewClark@SourceMage.org>
#

option_list() {
  # Return a dialog-friendly list of modules and attributes
  for NAME in $OPTIONLIST
  do
    source $OPTIONDIR/$NAME
    echo $NAME
    echo $QUESTION
    echo $STATUS
  done
}

option_config() {

  while true
  do
    OUTPUT=$( $DIALOG --title "$TITLE" --nocancel \
    --checklist "Select which features you'd like supported. If you don't know what these are, then just press OK to build all features." \
    0 0 0 \
    $(option_list) )

    RETVAL=$?
    if [ $RETVAL == 0 ]
    then
      FIRSTFIELD=$( echo $OUTPUT | cut -d' ' -f1 )
      REST=$( echo $OUTPUT | cut -d' ' -f2- )

      # OK was pressed
      # OUTPUT now contains the list of modules to build
      output_option_config
      break
    else
      # CANCEL was pressed
      break
    fi
  done
}

output_option_config() {
  # Function to output the configuration info to $SPELL_CONFIG

  # First we need to strip the quotes out of $OUTPUT
  OUTPUT=$( echo $OUTPUT | sed -e 's/\"//g' )

  # Iterate through all the options. TARGET is the
  # first unmatched option in the list of options
  # to enable. NAME is the name of the target option

  local TARGET=$( echo $OUTPUT | cut -d' ' -f1 )
  if [ "${TARGET:0:1}" != "m" ]
  then
    TARGET=${TARGET:1}
  fi
  local NAME

  for OPTION in $OPTIONLIST
  do
    if [ "$TARGET" = "" ] || [ "$TARGET" != "$OPTION" ]
    then
      # Disable this option
      echo "$NAME=n" >> $SPELL_CONFIG
    else
      # Enable this option
      echo "$NAME=y" >> $SPELL_CONFIG
    fi
  done
}


# Perform the configuration
if ! grep -q 'CONFIGURED=y' $SPELL_CONFIG; then
  local oldIFS=$IFS
  export IFS="
"

  TITLE="net-conf option selection"
  OPTIONDIR="$SCRIPT_DIRECTORY/options"
  OPTIONLIST=`ls $OPTIONDIR`
  DIALOG="dialog
--backtitle
net-conf option selection
--stdout"

  if query "Would you like to selection options from the menu? (N will build all options)" n
  then

    option_config
    CONFIG_OPTS=$SPELL_CONFIG

  else

    CONFIG_OPTS="
    GETTEXT=y\n\
    UNIX=y\n\
    INET=y\n\
    INET6=y\n\
    NOVELL=y\n\
    APPLETALK=y\n\
    AFAX25=y\n\
    AFNETROM=y\n\
    AFROSE=y\n\
    AFX25=y\n\
    AFECONET=y\n\
    AFASH=y\n\
    ETHERNET=y\n\
    ARCNET=y\n\
    SLIP=y\n\
    PPP=y\n\
    IPIP=y\n\
    STRIP=y\n\
    TOKEN=y\n\
    HWAX25=y\n\
    HWROSE=y\n\
    HWNETROM=y\n\
    HWX25=y\n\
    FRAME=y\n\
    SIT=y\n\
    FDDI=y\n\
    HIPPI=y\n\
    HWASH=y\n\
    CISCO=y\n\
    IRDA=y\n\
    HWECONET=y\n\
    IPMASQ=y\n\
    IPTOOLS=y\n\
    DECNET=n\n\
    MII=y\n"

  fi

  # we're gonna disable decnet support without asking -- it's broke 
  persistent_add DECNET
  echo 'DECNET=n\nCONFIGURED=y' >> $SPELL_CONFIG

  IFS=$oldIFS

fi
