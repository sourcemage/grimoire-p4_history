#!/bin/bash

DESCRIPTION="Con Kolivas Patchset"
SHORT="These are patches designed to improve system responsiveness, with emphasis on desktop pcs"
HELP="See http://kernel.kolivas.net

Contains:
 batch O(1) scheduler, preemptible, low latency
 C.K.'s interactivity patch
 Read Latency2, Variable HZ setting
 Desktop Tuning 1 and 2, Scheduler Tunables
 Supermount-NG
 XFS file system, Bootsplash, Grsec"

VERSIONS="2.4.22-ck2
2.4.21-ck3"

MD5S[0]=c3fb8c10931b2c17c18713805d260d9b
MD5S[1]=5fe3e852bedfe5c7641b0732004d3c24

CUSTOM=ck_custom
CMENU=(\
    "2.4.22-1000-ckbase-0309132043"     "Base ck patch"               "Base ck contains the batch O(1) scheduler, preemptible, low latency and my interactivity patch" \
    "2.4.22-1010-aavm-0309132047"         "Autoregulation vm hacks"     "This uses the default VM but changes the page inactivation according to the degree of memory stress, and the system stress." \
    "2.4.22-1020-rl2"          "Read Latency 2"              "Read Latency 2" \
    "2.4.22-1021-rl2dt"           "Desktop Tuning 1"            "Changes to the default settings for I/O, Hz and scheduler tunables for optimum responsiveness & interactivity." \
    "2.4.22-1030-vh"           "Variable HZ setting"         "If you change the Hz, use a multiple of 100. There really is no point going above 1000 Hz." \
    "2.4.22-1031-vhdt"          "Desktop Tuning 2"            "Changes to the default settings for I/O, Hz and scheduler tunables for optimum responsiveness & interactivity." \
    "2.4.22-1040-sm" "Supermount-NG v1.2.8"       "Supermount-NG v1.2.8" \
    "2.4.22-1050-bs"           "Bootsplash"                  "See http://www.bootsplash.org" \
    "2.4.22-1060-xfs-0309131631" "XFS file system"   "This is possibly safer with preempt disabled. It may have unimportant patch reject with aavm but works ok." \
    "2.4.22-1070-grsec-0309132055"    "Grsec"                "needs 1010 and 1060" \
   )

CMD5=(\
    "115543958883b582b7aa3f5464e3a1b1" \
    "d825991c7085650eb8d367530526ccc6" \
    "84de014de201ae71ab0e8916ecea4db1" \
    "b5ef4d1c46ee5c8f87f28a91980052d7" \
    "8fa3d2a2ff25f8a0e2fc5da14084d420" \
    "42dcd60df8554ae445789c64d8a0695c" \
    "83fc8add1714bd4a85221c8229926621" \
    "b1a2b9d0479cdf46707f6cebc8114dfe" \
    "faf6c417d13bb8265e8e33e2f765c09d" \
    "0f48accbb191d15497ff3e6096296b2c" \
   )

if [[ "$1" == "CONFIG" ]]; then
  if [[ "${!PATCH}" == "custom" ]]; then
    for CPATCH in $CK_PATCH; do
      echo "
SOURCE${COUNTER}=patch-${CPATCH}.bz2
SOURCE${COUNTER}_URL[0]=http://ck.kolivas.org/patches/2.4/2.4.22/2.4.22-ck2/split-out/\$SOURCE${COUNTER}" >> ${SPELL_CONFIG}.DETAILS
    (ck_md5_custom $(( $COUNTER - 1 )) $CPATCH) >> ${SPELL_CONFIG}.DETAILS
    COUNTER=$(( $COUNTER + 1 ))
    done
    COUNTER=$(( $COUNTER - 1 ))
  else
    echo "
SOURCE${COUNTER}=patch-${!PATCH}.bz2
SOURCE${COUNTER}_URL[0]=http://ck.kolivas.org/patches/2.4/2.4.22/2.4.22-ck2/\$SOURCE${COUNTER}" >> ${SPELL_CONFIG}.DETAILS

    source $SCRIPT_DIRECTORY/MD5PATCH
  fi
fi

ck_md5_custom()
{
  local CMENU_COUNT=${#CMENU[@]}
  local INDEX=0
  while [[ $INDEX -lt $CMENU_COUNT ]]; do
    if [[ "$2" == "${CMENU[$INDEX * 3]}" ]]; then
      echo "MD5[$1]=${CMD5[$INDEX]}
"
    fi
    INDEX=$(( $INDEX + 1 ))
  done
}

ck_checklist()
{
  local CMENU_COUNT=${#CMENU[@]}
  local INDEX=0
  while [[ $INDEX -lt $CMENU_COUNT ]]; do
    echo ${CMENU[$INDEX]}
    echo ${CMENU[$(( $INDEX + 1 ))]}
    echo "OFF"
    echo ${CMENU[$(( $INDEX + 2 ))]}
    INDEX=$(( $INDEX + 3 ))
  done
}

ck_custom()
{
  CK_PATCH=$( $DIALOG --title "$DESCRIPTION"  \
           --item-help                        \
           --separate-output                  \
           --checklist                        \
           "$SHORT" 0 0 0                     \
           $(ck_checklist) )
}
