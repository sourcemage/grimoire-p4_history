
# kernel information directory
kernelsdir="${SCRIPT_DIRECTORY}/info/kernels"
# patches information directory
patchesdir="${SCRIPT_DIRECTORY}/info/patches"
# sourced from DETAILS to create SOURCE_URL SOURCE
# KERNEL_VERSION environmental vars
detailsdefaults="${CONFIG_CACHE}/details.defaults"
# Latest versions of your favorite kernel sources and patches
latestdefaults="${SCRIPT_DIRECTORY}/latest.defaults"
# debug log duh ;)
debug="${SCRIPT_DIRECTORY}/debug.log"

# Create the default KERNEL_ARCH variable
arch_default()
{
	if [ -z "$KERNEL_ARCH" ]
	then
		case  `uname -m`  in
			alpha) KERNEL_ARCH=alpha   ;;
			arm) KERNEL_ARCH=arm     ;;
			cris) KERNEL_ARCH=cris    ;;
			ia64) KERNEL_ARCH=ia64    ;;
			i*86) KERNEL_ARCH=i386    ;;
			m68k) KERNEL_ARCH=m68k    ;;
			mips) KERNEL_ARCH=mips    ;;
			mips64) KERNEL_ARCH=mips64  ;;
			parisc) KERNEL_ARCH=parisc  ;;
			powerpc) KERNEL_ARCH=ppc     ;;
			ppc) KERNEL_ARCH=ppc     ;;
			powerpc64) KERNEL_ARCH=ppc64   ;;
			s390) KERNEL_ARCH=s390    ;;
			s390x) KERNEL_ARCH=s390x   ;;
			sh*) KERNEL_ARCH=sh      ;;
			sparc) KERNEL_ARCH=sparc   ;;
			sparc64) KERNEL_ARCH=sparc64 ;;
			x86_64) KERNEL_ARCH=x86_64  ;;
		esac		
	fi
}

# create the defaults file from scratch
# do this with every -r command
create_defaults()
{
	if [ -f ${BUILD_DIRECTORY}/linux-${VERSION}/.spell-config.p ]
	then
		cp ${BUILD_DIRECTORY}/linux-${VERSION}/.spell-config.p ${SPELL_CONFIG}.p
		persistent_load
	else
		arch_default
		kernel_arch=$KERNEL_ARCH
		persistent_add kernel_arch
		mode="newktree"
		persistent_add mode
		if [[ $RECONFIGURE ]]
		then
			reconf="true"
		else
			reconf="false"
		fi
		persistent_add reconf
		kver="LATEST_2_6"
		persistent_add kver
		patches=""
		persistent_add patches
		persistent_save
		persistent_load
	fi
}

# dialog command works even if you add --nocancel as part of the arguments
dialog="dialog --stdout --cancel-label Save_and_Exit"

# simply list ${BUILD_DIRECTORY} linux sources 
list_usr_src()
{
        linuxsrcs="`ls -1d ${BUILD_DIRECTORY}/linux-*`"
        for linuxsrc in $linuxsrcs
        do
                if [ -d $linuxsrc ]
                then
                        echo "$linuxsrc"
                        echo "Source_Tree"
                        echo "Use_${linuxsrc}_as_the_source_tree"
                fi
	done
}
																			
# main menu uhhh, what else is there to say?
main_menu()
{
	while true
	do
		persistent_load
		mode=$( $dialog --title "New or Used Kernel Tree" \
		--item-help --default-item "$mode" \
		--menu \
		"Would you like to use a new kernel tree or an existing one?" 0 0 0 \
		"newktree" "New Kernel Tree" "I want to use a new kernel tree"  \
		"oldktree" "Old Kernel Tree" "I want to use an old kernel tree"  \
		"Options" "Menu" "Kernel Arch, Build Dir, Cleaning"  \
		
		)
		retval="$?"
		if [ "$retval" == "0" ]
		then
			case "$mode" in
				"newktree") 
					persistent_save
					persistent_load
					new_tree_menu 
					;;
				"oldktree")
					persistent_save
					persistent_load
					old_src_menu
					;;
				"Options")
					options_menu
					;;
				*) break ;;
			esac
		else
			break
		fi
	done
}

# clean a source directory ($1)
clean_src_menu()
{
	while true
	do
		clean_options=$( $dialog --title "Clean Menu" \
			--item-help --menu \
			"How to Clean" 0 0 0 \
			"mrproper" "Clean $1 with mrproper" "Clean Source" \
			"clean" "Clean $1 with clean" "Clean Source" )
		retval="$?"
		if [ "$retval" == "0" ]
		then
			tmpdir="`pwd`"
			cd $1
			make ${clean_options}
			cd ${tmpdir}
		else
			break
		fi
	done
}
# select which kernel source to clean
# pass that kernel source to clean_src_menu
clean_menu()
{
        while true
        do
                menu_option=$( $dialog --title "Clean Menu" \
			--item-help --menu \
			"Which Kenrel" 0 0 0 $( list_usr_src ) )
		retval="$?"
		if [ "$retval" == "0" ]
		then
			clean_src_menu ${menu_option}
		else
			break
		fi
	done
}

# making other package types for other Linux distros
other_pkg_src_menu()
{
	while true
	do
		menu_option=$( $dialog --title "Options Menu" \
			--item-help --menu \
			"Other Package Creation" 0 0 0 \
			"rpm" "Make an RPM package" "Requires RPM" \
			"rpm-pkg" "Make another RPM package" "Requires RPM" \
			"binrpm-pkg" "Okay more RPM packages" "Requires RPM" \
			"deb-pkg" "Make a Debian Package" "Requires Debian Package Utilities" 
			)
		retval="$?"
		if [ "$retval" == "0" ]
		then
			tmpdir="`pwd`"
			cd $1
			make ${menu_option}
			cd $tmpdir
		else
			break
		fi
	done
}

# list the linux sources to make other package types
other_package_menu()
{
	while true
	do
		menu_option=$( $dialog --title "Options Menu" \
			--item-help --menu \
			"Select a Kernel Source" 0 0 0 $( list_usr_src ) )
		retval="$?"
		if [ "$retval" == "0" ]
		then
			other_pkg_src_menu ${menu_option}
		else
			break
		fi
	done
}

# select other arch to compile for
arch_menu() 
{
	arch_default
	local DEFAULT=${KERNEL_ARCH}
	local COMMAND
	while true
	do
		COMMAND=$( $dialog --title "Select Kernel Architecture"       \
		--item-help --default-item "$DEFAULT" --menu      \
		"Select a kernel architecture to use" 0 0 0            \
		"CUSTOM"             "Manually enter some other Architecture"           "You can enter any valid architecture" \
		"DEFAULT"            "Default Kernel Architecture"                      "The detected architecture for your platform, $DEFAULT" \
		"alpha"              "DEC/Compaq 64-bit Alpha"                          "DEC Alpha" \
		"arm"                "Embedded Processors using 32-bit ARM processors"  "ARM 32-bit" \
		"cris"               "Embedded Axis ETRAX CRIS processors 32-bit"       "Axis ETRAX CRIS" \
		"ia64"               "Intel Architecture 64-bit Itanium"                "Intel IA64 64-bit" \
		"i386"               "Intel Architecture 32-bit 386 through Pentium 4"  "Intel x86 32-bit" \
		"m68k"               "Motorola 68000 series 32-bit (older Macintosh)"   "m68k 32-bit" \
		"mips"               "MIPS Technologies 32-bit compatible processors"   "MIPS32 platforms" \
		"mips64"             "MIPS Technologies 64-bit compatible processors"   "MIPS64 platforms" \
		"parisc"             "HP PA-RISC 32 and 64-bit processors"              "PA-RISC 32-bit mode" \
		"ppc"                "PowerPC 32-bit (IBM and Motorola) G3/G4 Mac"      "PPC32 G3/G4" \
		"ppc64"              "PowerPC 64-bit (IBM) G5 Mac"                      "PPC64 G5" \
		"s390"               "IBM s390  31-bit systems"                         "IBM s390 31-bit" \
		"s390x"              "IBM s390x 64-bit systems"                         "IBM s390 64-bit" \
		"sh"                 "SuperH processors sh4 is 32-bit, sh5 is 64-bit"   "SH4 and SH5 32-bit mode" \
		"sparc"              "Sun SPARC 32-bit processors"                      "Sun SPARC 32-bit" \
		"sparc64"            "Sun SPARC 64-bit processors"                      "Sun SPARC 64-bit" \
		"x86_64"             "AMD x86-64 64-bit Hammer/Opteron/Athlon64 chips"  "AMD x86-64 Hammer"
		)
		retval=$?
		if [[ "$retval" == "0" ]]
		then
			if [[ $COMMAND == "CUSTOM" ]]
			then
				COMMAND=$($dialog --nocancel --inputbox "Which Architecture do you want to build?\nYou can enter any valid architecture.\nExamples:\n$i386\nppc\nx86_64\nsparc\nsparc64" 0 0 ${KERNEL_ARCH})
			elif [[ $COMMAND == "DEFAULT" ]]
			then
				COMMAND="$DEFAULT"
			fi
			kernel_arch=$COMMAND
			persistent_save
			persistent_load
			break
		else
			break
		fi
	done
}

# change the O option for the kernel
build_dir_menu()
{
	output_dir=$( $dialog --nocancel --inputbox \
	"Would you like to select a kernel output dir.\n\
	Leave it blank for no output dir\n" 0 0 ${output_dir} )
	retval="$?"
	echo $retval
	if [[ "$retval" == "0" && "$output_dir" != "" ]]
	then
		OPTIONAL_BUILD_DIR=$output_dir
		persistent_add OPTIONAL_BUILD_DIR
		persistent_save
		persistent_load
		echo "first ifstatment"
	elif [[ "$retval" == "0" && "$output_dir" == "" ]]
	then
		persistent_remove OPTIONAL_BUILD_DIR
		persistent_save
		persistent_load
		echo "second ifstatment"
	else
		echo "Do nothing"
	fi
}

# restore a config file from a different location
restore_config()
{
	. ${SCRIPT_DIRECTORY}/DETAILS
	while true
	do
		menu_option=$( $dialog --title "Config Restore" \
			--item-help --menu \
			"Restore Config From:" 0 0 0 \
			"/proc/config.gz" "Restore" "Save /proc/config.gz to ${CONFIG_CACHE}/kernel.config" \
			"/boot/config-$VERSION" "Restore" "Save /boot/config-$VERSION to ${CONFIG_CACHE}/kernel.config" \
			"Custom" "Restore" "Save custom config file to ${CONFIG_CACHE}/kernel.config" \
			)
		retval="$?"
		if [ "$retval" == "0" ]
		then
			case "${menu_option}" in
				"/proc/config.gz")
					if [ -f ${menu_option} ]
					then
						zcat /proc/config.gz > ${CONFIG_CACHE}/kernel.config
					fi
					;;
				"/boot/config-$VERSION")
					if [ -f ${menu_option} ]
					then
						cp /boot/config-$VERSION ${CONFIG_CACHE}/kernel.config
					fi
					;;
				"Custom")
					menu_option=$( $dialog --title "Config Restore" \
						--nocancel --inputbox \
						"Enter Custom File to Save to ${CONFIG_CACHE}/kernel.config" \
						0 0 ${menu_option} )
					if [ -f ${menu_option} ]
					then
						cp ${menu_option} ${CONFIG_CACHE}/kernel.config
					fi
					;;
			esac
			break
		else
			break
		fi
	done
}

# other misc options menu
options_menu()
{
	while true
	do
		menu_option=$( $dialog --title "Options Menu" \
			--item-help --menu \
			"Options Menu Yeah Fun" 0 0 0 \
			"Clean" "Options" "Clean the Source Tree" \
			"Arch" "Selection" "Select Arch Default is $ARCH" \
			"Optional" "Build Dir" "Build the source to an output directory" \
			"Config" "Restoration" "Optional config restoration" \
			"Other" "Packages" "Make an RPM or Debian Package" \
			"Initrd" "Creation" "Make an bootable initrd" 
			)
		retval="`echo $?`"
		if [[ "$retval" == "0" ]]
		then
			case "${menu_option}" in
				"Clean")
					clean_menu
					;;
				"Arch")
					arch_menu
					;;
				"Optional")
					build_dir_menu
					;;
				"Other")
					other_package_menu
					;;
				"Config")
					restore_config
					;;
				"Initrd")
					
					;;
				*) break ;;
			esac
		else
			break
		fi
	done
}

# create a new linux source tree
# I use awk to parse the latest.defaults file
# that should be changed but how?
new_tree_menu() 
{
	while true
	do
		menu=""
		versions="`ls -r1 $kernelsdir`"
		for version in $versions
		do
			menu="${menu}${version} Linux_Kernel Select_one "
		done
		menu="$( awk -F= '$1 ~ /LATEST_2/ {print $1 " Linux_Kernel " $2 }' $latestdefaults ) ${menu}"
		kver=$( $dialog --title "Select Kernel Version" \
		--item-help --default-item "$kver" --menu \
		"Select a kernel version to use" 0 0 0 \
		$menu )
		retval="$?"
		if [ "$retval" == "0" ]
		then
			case "$kver" in
				2.[0-9].[0-9]*) 
					persistent_save
					persistent_load
					patch_menu $kver
					;;
				LATEST*)
					persistent_save
					persistent_load
					patch_menu $kver
					;;
				*) 
					persistent_load
					break 
					;;
			esac
		else
			break
		fi
	done
}

# find all patches list the directories and LATEST patches for the kernel version $1
patch_list()
{
	. $latestdefaults
	case "$1" in
		LATEST*)
			argv1=${!1}
			;;
		*)
			argv1=$1
			;;
	esac
	patches="`ls -1 $patchesdir/`"
	for patch in $patches
	do
		tmp="LATEST_$patch"
		if [ "${!tmp}" != "" ]
		then
			. $patchesdir/$patch/${!tmp}
			for applied in $appliedkernels
			do
				if [ $applied == $argv1 ]
				then
					echo LATEST_$patch
					echo ${!tmp}
					echo $patch
				fi
			done
		fi
		patchvers="`ls -1 $patchesdir/${patch}`"
		found="false"
		for patchver in $patchvers
		do
			. $patchesdir/$patch/$patchver
			for applied in $appliedkernels
			do
				if [ $argv1 == $applied ]
				then
					found="true"
				fi
			done
		done
		if [ "$found" == "true" ]
		then
			echo $patch
			echo Patch
			echo Select_Specific_$patch
		fi
	done
}

# list all patches for kernel version $1 and for patch $2
list_specific_patch_dir()
{
	. $latestdefaults
	case $1 in
		LATEST*)
			argv1=${!1}
			;;
		*)
			argv1=$1
			;;
	esac
	patchvers="`ls -1 $patchesdir/$2`"
	for patchver in $patchvers
	do
		. $patchesdir/$2/$patchver
		for applied in $appliedkernels
		do
			if [ $argv1 == $applied ]
			then
				echo $patchver
				echo PATCH
				echo $2
			fi
		done
	done
}

# main patch menu called from main_menu
# list directories and valid latest patches
# that apply to the kernel version $1
patch_menu() 
{
	while true
	do
		menu=$(patch_list $1)
		if [ "$menu" == "" ]
		then
			menu="No_Patches Available Sorry"
		fi
		command=$( $dialog --title "Select Patches" \
			--item-help --menu \
			"Currently selected patches: $new_patch_list" 0 0 0 ${menu}
			)
		retval="$?"
		if [[ "$retval" == "0" && "$command" != "No_Patches" ]]
		then
			case "$command" in
				LATEST*)
					;;
				*)
					echo $1
					echo $command	
					command=$( $dialog --title "Select Patches" \
						--item-help --menu \
						"Currently selected patches: $new_patch_list" 0 0 0 \
						$(list_specific_patch_dir $1 $command) )
					;;
			esac
			found=false
			tmp_patch_list=""
			for patch in $new_patch_list
			do
				if [ "$command" != "$patch" ]
				then
					tmp_patch_list="${tmp_patch_list}${patch} "
				else
					found="true"
				fi
					
			done
			if [ "$found" == "true" ]
			then
				new_patch_list=$tmp_patch_list
			else
				new_patch_list="${new_patch_list}${command} "
			fi
		else
			patches=$new_patch_list
			persistent_save
			persistent_load
			break
		fi
	done
}

# list the old source menu to reconfigure an old source tree
old_src_menu()
{
	while true
	do
		old_src_tree=$( $dialog --title "Select Old Source Tree" \
				--item-help \
				--default-item "$BUILD_DIRECTORY/$old_src_tree"\
				--menu \
				"Select Old Source Tree" 0 0 0 $( list_usr_src ) )
		retval="$?"
		if [ "$retval" == "0" ]
		then
			[ -f ${old_src_tree}/.spell-config.p ] &&
			cp ${old_src_tree}/.spell-config.p ${SPELL_CONFIG}.p &&
			persistent_load
			persistent_add old_src_tree
			mode="oldktree"
			persistent_remove MAKEMODE
			persistent_save
			persistent_load
			break
		else
			break
		fi
	done
}

# if any of the patches needs any other patches applied before it is
# for example the mm patches apply against the pre patched kernel
calculate_depends()
{
	# really this should be done with a make file
	new_patch_list=""
	for patch in $patches
	do
		case "$patch" in
			LATEST*)
				. $patchesdir/*/${!patch}
				if [ "$depends" != "" ]
				then
					new_patch_list="${new_patch_list}${depends} "
				fi
				;;
			*)
				. $patchesdir/*/${patch}
				if [ "$depends" != "" ]
				then
					new_patch_list="${new_patch_list}${depends} "
				fi
				;;
		esac
		patches="${new_patch_list}${patch} "
		persistent_save
		persistent_load
	done
}

# created details.defaults file to be sourced by DETAILS file for VERSION SOURCE_URL SOURCE
# stuff like that
create_details()
{
	persistent_load
	. $latestdefaults
	local counter="1"
	case "$mode" in
		*ktree)
			(
			#this might be cool if it didn't take more than what's up there.
			#calculate_depends
			for patch in $patches
			do
				case "$patch" in
					LATEST*)
						. $patchesdir/*/${!patch}
						echo "PATCH[${counter}]=\$${patch}"
						echo -n '. ${SCRIPT_DIRECTORY}/info/patches/*/${PATCH['
						echo -n $counter
						echo ']}'
						echo "SOURCE${counter}=\$source"
						echo "MD5[${counter}]=\$md5sum"
						echo "SOURCE${counter}_URL=\${source_url}"
						;;
					*)
						. $patchesdir/*/${patch}
						echo "PATCH[${counter}]=${patchversion}"
						echo "SOURCE${counter}=$source"
						echo "MD5[${counter}]=$md5sum"
						echo "SOURCE${counter}_URL=$source_url"
						;;
				esac
				counter="`expr $counter + 1`"
			done

                        case "$kver" in
				LATEST*)
					. $kernelsdir/${!kver}
					echo "KERNEL_VERSION=\$$kver"
					echo '. ${SCRIPT_DIRECTORY}/info/kernels/${KERNEL_VERSION}'
					echo "SOURCE=\$source"
					echo "MD5[0]=\$md5sum"
					echo "SOURCE_URL=\$source_url"
					;;
				*)
					. $kernelsdir/${kver}
					echo "KERNEL_VERSION=$kver"
					echo "SOURCE=$source"
					echo "MD5[0]=$md5sum"
					echo "SOURCE_URL=$source_url"
					;;
			esac
			if [[ $patchversion == "" ]]
			then
				case "$kver" in
					LATEST*)
						append=${!kver}
						;;
					*)
						append=$kver
						;;
				esac
			else
				append=$patchversion
			fi
			echo "LINUX_SOURCE_DIRECTORY=\${BUILD_DIRECTORY}/linux-$append"
			) > $detailsdefaults
			;;
#		oldktree)
#			;;
		*)
			echo "I don't know what the hell is $mode"
			;;
	esac
}

# Start of the execution

# if it's not there create it
create_defaults

if [[ "$reconf" == "true" || "$kver" == "" ]]
then
	main_menu
	persistent_load
	if [ "$kver" == "" ]
	then
		echo "You really need to tell the spell what linux kernel you are dealing with."
		sleep 5
	fi
	while [ "$kver" == "" ]
	do
		main_menu
		persistent_load
		if [ "$kver" == "" ]
		then
			echo "You really need to tell the spell what linux kernel you are dealing with."
			sleep 5
		fi	
	done
	create_details
else
	echo "No Reconfigure, using ${SPELL_CONFIG}.p for defaults"
fi

persistent_load
