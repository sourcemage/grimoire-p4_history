# Install global config file and Registry

function install_root_config {
    echo "Creating Root Config"
    [ -d ~/.wine ] || mkdir ~/.wine
    [ -f /root/.wine/config ] || [ -h /root/.wine/config ] || cp $EXDIR/config ~/.wine/config
    if [ "$GLOBAL_C" == "n" ];then
	[ -h $CROOT ] || ln -s $GLOBAL_CROOT $CROOT
    fi
}

function install_root_registry {
    echo "Creating Root Registry"
    [ -f /root/.wine/system.reg ] || [ -h /root/.wine/system.reg ] || $RUNDLL32 setupapi.dll,InstallHinfSection DefaultInstall 128 $INFSCRIPT > /dev/null || exit 1
}

function global_registry {
    echo "Creating Global Config file"
    [ -d $SYSCONFDIR ] || mkdir -p $SYSCONFDIR
    [ -f $SYSCONFDIR/wine.conf ] || mv /root/.wine/config $SYSCONFDIR/wine.conf
    [ -f /root/.wine/config ] || [ -h /root/.wine/config ] || ln -s $SYSCONFDIR/wine.conf /root/.wine/config

# sometimes it takes a few seconds for the registry to appear in the directory
# do nothing loop to ensure that the files appear after the regedit above.
#
# I need to check to see if this is still necissary.
#
#
    DONOTHING=1
    while [ ! -f /root/.wine/system.reg ] && [ ! -h /root/.wine/system.reg ]
      do
      DONOTHING=$[$DONOTHING + 1]
    done

    echo "Creating Global Registry"
    [ -f $SYSCONFDIR/system.reg ] || mv /root/.wine/system.reg $SYSCONFDIR/system.reg
    [ -f /root/.wine/system.reg ] || [ -h /root/.wine/system.reg ] || ln -s $SYSCONFDIR/system.reg /root/.wine/system.reg
    [ -f $SYSCONFDIR/userdef.reg ] || mv /root/.wine/userdef.reg $SYSCONFDIR/userdef.reg
    [ -f /root/.wine/userdef.reg ] || [ -h /root/.wine/userdef.reg ] || [ -h /root/.wine/userdef.reg ] || ln -s $SYSCONFDIR/userdef.reg /root/.wine/userdef.reg
    [ -f $SYSCONFDIR/user.reg ] || mv /root/.wine/user.reg $SYSCONFDIR/user.reg
    [ -f /root/.wine/user.reg ] || [ -h /root/.wine/user.reg ] || ln -s $SYSCONFDIR/user.reg /root/.wine/user.reg
    if [ "$GLOBAL_C" == "y" ]; then
        # ensure that users can write to the registry
	chgrp -R users $SYSCONFDIR
	chmod -R g+w $SYSCONFDIR
    fi
}

function local_registry {
# for all normal users
#
# with patches, I wonder if this is necissary?
    echo "Installing user config files and registries."
    for i in `cat /etc/sorcery/local/wine.users`
      do
      echo "Installing ${i}'s config file."
      su -c "[ -d ~/.wine/ ] || mkdir ~/.wine/" $i &&
      if [ "$GLOBAL_CONFIG" == "y" ]; then
	  su -c "[ -f ~/.wine/config ] || [ -h ~/.wine/config ] || ln -s $SYSCONFDIR/wine.conf ~/.wine/config" $i
      else
	  su -c "[ -f ~/.wine/config ] || [ -h ~/.wine/config ] || cp $SYSCONFDIR/wine.conf ~/.wine/config" $i
      fi
      if [ "$GLOBAL_C" == "y" ]; then
	  echo "Installing ${i}'s registry."
	  su -c "[ -f ~/.wine/system.reg ] || [ -h ~/.wine/system.reg ] || ln -s $SYSCONFDIR/system.reg ~/.wine/system.reg" $i
	  su -c "[ -f ~/.wine/userdef.reg ] || [ -h ~/.wine/userdef.reg ] || ln -s $SYSCONFDIR/userdef.reg ~/.wine/userdef.reg" $i
	  su -c "[ -f ~/.wine/user.reg ] || [ -h ~/.wine/user.reg ] || ln -s $SYSCONFDIR/user.reg ~/.wine/user.reg" $i
      else
	  CROOT=/home/$i/.wine/fake_C #has to be set again, otherwise it's set to /root/.wine/fake_C
	  echo "Installing ${i}'s fake_C."
	  su -c "[ -d $CROOT ] || cp -r $GLOBAL_CROOT $CROOT" $i
	  echo "Installing ${i}'s registry."
	  su -c "[ -f ~/.wine/system.reg ] || [ -h ~/.wine/system.reg ] || $RUNDLL32 setupapi.dll,InstallHinfSection DefaultInstall 128 $INFSCRIPT" $i
      fi
    done
}

install_root_config &&
install_root_registry &&
global_registry &&
if [ "$WINEUSERS" == "y" ]; then
	local_registry
else
    echo "For wine to work, each user must have a ~/.wine/ directory"
    echo "containing a 'config' file and a registry."
    echo "You can either copy or symlink the 'config' file from"
    echo "/etc/wine/wine.conf."
    echo "For the registry, if you wish to share the registries"
    echo "you must symlink them to /etc/wine/*.reg."
    echo "If you prefer to have your fake_C local to the individual"
    echo "user, copy the default fake_C '/var/wine' where you want it"
    echo "in the users home directory, adjust the users individual config"
    echo "file accordingly."
    echo "The registry is copied from the default registry in /etc/wine/"
    echo "The first time wine is run."
fi
